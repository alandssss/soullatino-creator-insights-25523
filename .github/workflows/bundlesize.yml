name: Bundle Size Check
on: 
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with: 
          node-version: "20"
          cache: "npm"
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build production bundle
        run: npm run build
        
      - name: Check bundle size
        run: |
          BUNDLE_SIZE=$(du -sb dist/assets/*.js | awk '{sum+=$1} END {print sum}')
          BUNDLE_SIZE_KB=$((BUNDLE_SIZE / 1024))
          BUNDLE_SIZE_MB=$((BUNDLE_SIZE_KB / 1024))
          echo "Bundle size: ${BUNDLE_SIZE_KB} KB (${BUNDLE_SIZE_MB} MB)"
          
          # Target: < 840KB (860160 bytes)
          MAX_SIZE=860160
          if [ $BUNDLE_SIZE -gt $MAX_SIZE ]; then
            echo "❌ Bundle size exceeds limit: ${BUNDLE_SIZE_KB}KB > 840KB"
            exit 1
          else
            echo "✅ Bundle size within limit: ${BUNDLE_SIZE_KB}KB <= 840KB"
          fi
          
      - name: Analyze bundle
        run: npm run build -- --analyze || true
